# Multi-Provider Architecture: Visual Guide

**Visual comparison of current vs proposed architecture**

---

## Before: Single Provider (Current)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT REQUEST                           â”‚
â”‚                    POST /api/generate                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API ROUTES                               â”‚
â”‚                    (routes/api.js)                               â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Parse request body                                            â”‚
â”‚  â€¢ Validate input                                                â”‚
â”‚  â€¢ Call docGenerator                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DOC GENERATOR SERVICE                         â”‚
â”‚                  (services/docGenerator.js)                      â”‚
â”‚                                                                   â”‚
â”‚  const claudeClient = new ClaudeClient()  â—„â”€â”€ HARDCODED         â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Parse code (AST analysis)                                     â”‚
â”‚  â€¢ Build prompts                                                 â”‚
â”‚  â€¢ Call claudeClient.generate()                                  â”‚
â”‚  â€¢ Calculate quality score                                       â”‚
â”‚  â€¢ Add attribution                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLAUDE CLIENT                             â”‚
â”‚                   (services/claudeClient.js)                     â”‚
â”‚                                                                   â”‚
â”‚  const model = 'claude-sonnet-4-5-20250929'  â—„â”€â”€ HARDCODED      â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Wrap Anthropic SDK                                            â”‚
â”‚  â€¢ Handle retries (3x exponential backoff)                       â”‚
â”‚  â€¢ Extract error messages                                        â”‚
â”‚  â€¢ Manage prompt caching                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ANTHROPIC SDK                               â”‚
â”‚                  (@anthropic-ai/sdk)                             â”‚
â”‚                                                                   â”‚
â”‚  this.client.messages.create()                                   â”‚
â”‚  this.client.messages.stream()                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CLAUDE API    â”‚
                    â”‚  (Only Option) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Problems:**
- âŒ Tightly coupled to Claude (can't switch providers)
- âŒ Model name hardcoded (line 8 of claudeClient.js)
- âŒ No provider abstraction
- âŒ Hard to test (can't mock provider easily)
- âŒ Can't leverage other models (GPT-4, Gemini, etc.)

---

## After: Multi-Provider (Proposed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT REQUEST                           â”‚
â”‚                    POST /api/generate                            â”‚
â”‚         Optional: X-LLM-Provider: openai                         â”‚
â”‚                   X-LLM-Model: gpt-4-turbo-preview               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MIDDLEWARE                               â”‚
â”‚                  (middleware/llmProvider.js)                     â”‚
â”‚                                                                   â”‚
â”‚  req.llmProvider = llmFactory.createFromEnv()                    â”‚
â”‚    OR override from headers (X-LLM-Provider)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API ROUTES                               â”‚
â”‚                    (routes/api.js)                               â”‚
â”‚                                                                   â”‚
â”‚  const docGenerator = new DocGeneratorService(req.llmProvider)   â”‚
â”‚                                              â–²                    â”‚
â”‚                                              â”‚                    â”‚
â”‚                                    DEPENDENCY INJECTION          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DOC GENERATOR SERVICE                         â”‚
â”‚                  (services/docGenerator.js)                      â”‚
â”‚                                                                   â”‚
â”‚  constructor(llmProvider = null) {                               â”‚
â”‚    this.llmProvider = llmProvider || llmFactory.createFromEnv()  â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Parse code (same as before)                                   â”‚
â”‚  â€¢ Build prompts (same as before)                                â”‚
â”‚  â€¢ Call this.llmProvider.generate()  â—„â”€â”€ ABSTRACTED             â”‚
â”‚  â€¢ Calculate quality score (same)                                â”‚
â”‚  â€¢ Add attribution (same)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LLM FACTORY                              â”‚
â”‚                  (llm/factory/LLMFactory.js)                     â”‚
â”‚                                                                   â”‚
â”‚  createFromEnv() {                                               â”‚
â”‚    provider = process.env.LLM_PROVIDER  // 'anthropic' | 'openai'â”‚
â”‚    model = process.env.LLM_MODEL                                 â”‚
â”‚    return this.create({ provider, model, ... })                  â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  Registry:                                                       â”‚
â”‚    'anthropic' â†’ ClaudeProvider                                  â”‚
â”‚    'openai' â†’ OpenAIProvider                                     â”‚
â”‚    'azure-openai' â†’ AzureOpenAIProvider                          â”‚
â”‚    'bedrock' â†’ BedrockProvider                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  SELECT PROVIDER â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚               â”‚
        â–¼                    â–¼                    â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLAUDE     â”‚     â”‚   OPENAI     â”‚     â”‚    AZURE     â”‚     â”‚   BEDROCK    â”‚
â”‚  PROVIDER    â”‚     â”‚  PROVIDER    â”‚     â”‚   OPENAI     â”‚     â”‚  PROVIDER    â”‚
â”‚              â”‚     â”‚              â”‚     â”‚  PROVIDER    â”‚     â”‚              â”‚
â”‚ extends      â”‚     â”‚ extends      â”‚     â”‚ extends      â”‚     â”‚ extends      â”‚
â”‚ BaseLLM      â”‚     â”‚ BaseLLM      â”‚     â”‚ BaseLLM      â”‚     â”‚ BaseLLM      â”‚
â”‚ Provider     â”‚     â”‚ Provider     â”‚     â”‚ Provider     â”‚     â”‚ Provider     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Implements:        â”‚ Implements:        â”‚ Implements:        â”‚
       â”‚ â€¢ generate()       â”‚ â€¢ generate()       â”‚ â€¢ generate()       â”‚
       â”‚ â€¢ streaming()      â”‚ â€¢ streaming()      â”‚ â€¢ streaming()      â”‚
       â”‚ â€¢ capabilities()   â”‚ â€¢ capabilities()   â”‚ â€¢ capabilities()   â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â–¼                    â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Anthropic    â”‚     â”‚   OpenAI     â”‚     â”‚ Azure OpenAI â”‚     â”‚AWS Bedrock   â”‚
â”‚     SDK      â”‚     â”‚     SDK      â”‚     â”‚     SDK      â”‚     â”‚    SDK       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚
       â–¼                    â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude API  â”‚     â”‚  OpenAI API  â”‚     â”‚  Azure API   â”‚     â”‚  Bedrock API â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Benefits:**
- âœ… Provider-agnostic architecture
- âœ… Runtime provider switching (env vars or headers)
- âœ… Easy to add new providers
- âœ… Testable (inject mock providers)
- âœ… Cost optimization (use cheapest provider)
- âœ… Fallback chains (if Claude fails, try OpenAI)

---

## Provider Interface (Contract)

All providers must implement `BaseLLMProvider`:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BaseLLMProvider                            â”‚
â”‚                     (Abstract Interface)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ðŸ”´ ABSTRACT METHODS (Must Implement)                            â”‚
â”‚                                                                   â”‚
â”‚  async generate(prompt, options)                                 â”‚
â”‚    â†’ Returns: { text, metadata }                                 â”‚
â”‚    â†’ Throws: LLMError                                            â”‚
â”‚                                                                   â”‚
â”‚  async generateWithStreaming(prompt, onChunk, options)           â”‚
â”‚    â†’ Returns: { text, metadata }                                 â”‚
â”‚    â†’ Throws: LLMError                                            â”‚
â”‚                                                                   â”‚
â”‚  getCapabilities()                                               â”‚
â”‚    â†’ Returns: { streaming, caching, vision, ... }                â”‚
â”‚                                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ðŸŸ¢ CONCRETE METHODS (Provided by Base)                          â”‚
â”‚                                                                   â”‚
â”‚  _validateConfig(config)                                         â”‚
â”‚  _executeWithRetry(fn, operation)                                â”‚
â”‚  supportsStreaming() â†’ boolean                                   â”‚
â”‚  supportsCaching() â†’ boolean                                     â”‚
â”‚  getProviderName() â†’ string                                      â”‚
â”‚  getModel() â†’ string                                             â”‚
â”‚  estimateTokens(text) â†’ number                                   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Example Usage:**
```javascript
// Any provider works the same way
const provider = llmFactory.createFromEnv()

const result = await provider.generate('Explain quantum computing', {
  systemPrompt: 'You are a helpful assistant.',
  enableCaching: true,
  maxTokens: 4000
})

console.log(result.text)  // Generated text
console.log(result.metadata)  // { provider, model, tokens, latency, ... }
```

---

## Configuration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ENVIRONMENT VARIABLES                      â”‚
â”‚                         (server/.env)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  LLM_PROVIDER=anthropic         # or 'openai', 'azure-openai'   â”‚
â”‚  LLM_API_KEY=sk-ant-...         # API key                        â”‚
â”‚  LLM_MODEL=claude-sonnet-4...   # Model identifier               â”‚
â”‚  LLM_MAX_TOKENS=4000            # Max tokens per request         â”‚
â”‚  LLM_MAX_RETRIES=3              # Max retry attempts             â”‚
â”‚  LLM_ENABLE_CACHING=true        # Enable prompt caching          â”‚
â”‚                                                                   â”‚
â”‚  # Backward compatibility                                        â”‚
â”‚  CLAUDE_API_KEY=sk-ant-...      # Falls back to this if no key   â”‚
â”‚  OPENAI_API_KEY=sk-...                                           â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LLM CONFIG                               â”‚
â”‚                   (llm/config/LLMConfig.js)                      â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Load environment variables                                    â”‚
â”‚  â€¢ Validate configuration                                        â”‚
â”‚  â€¢ Apply defaults                                                â”‚
â”‚  â€¢ Provider-specific options                                     â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LLM FACTORY                              â”‚
â”‚                   (llm/factory/LLMFactory.js)                    â”‚
â”‚                                                                   â”‚
â”‚  createFromEnv() {                                               â”‚
â”‚    config = LLMConfig.get()                                      â”‚
â”‚    ProviderClass = this.registry.get(config.provider)            â”‚
â”‚    return new ProviderClass(config)                              â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PROVIDER INSTANCE                           â”‚
â”‚                   (ClaudeProvider, etc.)                         â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Initialized with validated config                             â”‚
â”‚  â€¢ Ready to generate text                                        â”‚
â”‚  â€¢ Singleton (reused across requests)                            â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Runtime Override (via Headers):**
```
POST /api/generate
X-LLM-Provider: openai
X-LLM-Model: gpt-4-turbo-preview

                     â†“

Middleware creates provider instance with header values
(overrides environment config for this request only)
```

---

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PROVIDER API CALL                            â”‚
â”‚          (Claude API, OpenAI API, Azure API, etc.)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                      âŒ API ERROR
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PROVIDER ADAPTER                            â”‚
â”‚                  (_adaptError() method)                          â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Parse provider-specific error format                          â”‚
â”‚  â€¢ Extract status code, error type, message                      â”‚
â”‚  â€¢ Convert to standard LLMError                                  â”‚
â”‚                                                                   â”‚
â”‚  Example (Claude):                                               â”‚
â”‚    status: 429 â†’ errorType: 'RATE_LIMIT'                         â”‚
â”‚    status: 401 â†’ errorType: 'AUTH'                               â”‚
â”‚    status: 500 â†’ errorType: 'SERVER_ERROR'                       â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LLM ERROR                                â”‚
â”‚                   (llm/providers/base/LLMError.js)               â”‚
â”‚                                                                   â”‚
â”‚  new LLMError('Rate limit exceeded', {                           â”‚
â”‚    provider: 'claude',                                           â”‚
â”‚    errorType: 'RATE_LIMIT',                                      â”‚
â”‚    statusCode: 429,                                              â”‚
â”‚    retryAfter: 60                                                â”‚
â”‚  })                                                              â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RETRY HELPER                              â”‚
â”‚                 (llm/providers/base/RetryHelper.js)              â”‚
â”‚                                                                   â”‚
â”‚  if (error.isRetryable()) {                                      â”‚
â”‚    wait exponential backoff (2^attempt * 1000ms)                 â”‚
â”‚    retry up to 3 times                                           â”‚
â”‚  } else {                                                        â”‚
â”‚    throw immediately (auth errors, validation errors)            â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  âœ… SUCCESS or âŒ MAX RETRIES
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DOC GENERATOR SERVICE                         â”‚
â”‚                                                                   â”‚
â”‚  catch (error) {                                                 â”‚
â”‚    if (error instanceof LLMError) {                              â”‚
â”‚      // Log with provider context                                â”‚
â”‚      console.error(`[${error.provider}] ${error.message}`)       â”‚
â”‚      throw error  // Re-throw for API route                      â”‚
â”‚    }                                                             â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API ROUTE                                â”‚
â”‚                                                                   â”‚
â”‚  catch (error) {                                                 â”‚
â”‚    const status = error.statusCode || 500                        â”‚
â”‚    res.status(status).json(error.toJSON())                       â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CLIENT RESPONSE                            â”‚
â”‚                                                                   â”‚
â”‚  {                                                               â”‚
â”‚    "error": "Claude API rate limit exceeded",                    â”‚
â”‚    "provider": "claude",                                         â”‚
â”‚    "errorType": "RATE_LIMIT",                                    â”‚
â”‚    "statusCode": 429,                                            â”‚
â”‚    "retryAfter": 60                                              â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Error Type Classification:**

| Error Type | Retryable? | Examples |
|------------|------------|----------|
| `AUTH` | âŒ No | Invalid API key |
| `RATE_LIMIT` | âœ… Yes (with backoff) | 429 rate limit |
| `VALIDATION` | âŒ No | Invalid parameters |
| `TIMEOUT` | âœ… Yes | Request timeout |
| `NETWORK` | âœ… Yes | Connection failed |
| `SERVER_ERROR` | âœ… Yes | 5xx errors |
| `QUOTA_EXCEEDED` | âŒ No | Account billing issue |
| `MODEL_NOT_FOUND` | âŒ No | Invalid model name |
| `UNKNOWN` | âŒ No | Unclassified error |

---

## Caching Strategy (Claude Only)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FIRST REQUEST                              â”‚
â”‚                  (with enableCaching: true)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLAUDE PROVIDER                             â”‚
â”‚                                                                   â”‚
â”‚  messages: [                                                     â”‚
â”‚    {                                                             â”‚
â”‚      role: 'system',                                             â”‚
â”‚      content: [{                                                 â”‚
â”‚        type: 'text',                                             â”‚
â”‚        text: 'You are a documentation generator...',             â”‚
â”‚        cache_control: { type: 'ephemeral' }  â—„â”€â”€ CACHE THIS     â”‚
â”‚      }]                                                          â”‚
â”‚    },                                                            â”‚
â”‚    {                                                             â”‚
â”‚      role: 'user',                                               â”‚
â”‚      content: 'Generate docs for: function add(a,b)...'          â”‚
â”‚    }                                                             â”‚
â”‚  ]                                                               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLAUDE API                                â”‚
â”‚                                                                   â”‚
â”‚  â€¢ Processes system prompt (2,000 tokens)                        â”‚
â”‚  â€¢ WRITES TO CACHE (cache_creation_input_tokens: 2000)           â”‚
â”‚  â€¢ Processes user message (500 tokens)                           â”‚
â”‚  â€¢ Generates response (1,000 tokens)                             â”‚
â”‚                                                                   â”‚
â”‚  Cost: 2,500 input tokens Ã— $0.003/1K = $0.0075                 â”‚
â”‚        1,000 output tokens Ã— $0.015/1K = $0.015                  â”‚
â”‚        Total: $0.0225                                            â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â±ï¸ CACHE TTL: 1 HOUR
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SECOND REQUEST                              â”‚
â”‚              (within 1 hour, same system prompt)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLAUDE API                                â”‚
â”‚                                                                   â”‚
â”‚  â€¢ READS FROM CACHE (cache_read_input_tokens: 2000)  âœ…         â”‚
â”‚  â€¢ Processes new user message (500 tokens)                       â”‚
â”‚  â€¢ Generates response (1,000 tokens)                             â”‚
â”‚                                                                   â”‚
â”‚  Cost: 2,000 cached tokens Ã— $0.0003/1K = $0.0006  â—„â”€â”€ 90% OFF  â”‚
â”‚        500 new input tokens Ã— $0.003/1K = $0.0015                â”‚
â”‚        1,000 output tokens Ã— $0.015/1K = $0.015                  â”‚
â”‚        Total: $0.0171 (saved $0.0054 = 24%)                      â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Response metadata:
{
  "inputTokens": 500,
  "outputTokens": 1000,
  "cacheReadTokens": 2000,  â—„â”€â”€ Indicates cache hit!
  "cacheWriteTokens": 0,
  "wasCached": true
}
```

**Caching Savings at Scale:**

| Scenario | Without Caching | With Caching | Savings |
|----------|-----------------|--------------|---------|
| 1 request/day | $0.02/day | $0.02/day (first) + $0.017/day (rest) | ~15% |
| 100 requests/day | $2.25/day | $0.022 + $1.71 = $1.73/day | ~23% |
| 1,000 requests/day | $22.50/day | $0.022 + $17.10 = $17.12/day | ~24% |

**At 1,000 requests/day:** $162/month saved!

---

## File Structure Comparison

### Before (Current)
```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ claudeClient.js       â—„â”€â”€ Tightly coupled to Claude
â”‚   â”‚   â”œâ”€â”€ docGenerator.js       â—„â”€â”€ Imports claudeClient directly
â”‚   â”‚   â”œâ”€â”€ codeParser.js
â”‚   â”‚   â””â”€â”€ qualityScorer.js
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ api.js
â”‚   â””â”€â”€ middleware/
â”‚       â””â”€â”€ (no LLM middleware)
â””â”€â”€ __tests__/
    â”œâ”€â”€ claudeClient.test.js
    â””â”€â”€ docGenerator.test.js
```

### After (Proposed)
```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ llm/                  â—„â”€â”€ NEW: LLM abstraction layer
â”‚   â”‚   â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BaseLLMProvider.js    (200 lines)
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LLMError.js           (50 lines)
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ RetryHelper.js        (60 lines)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ anthropic/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ClaudeProvider.js     (250 lines)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OpenAIProvider.js     (200 lines)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ factory/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ LLMFactory.js             (150 lines)
â”‚   â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ LLMConfig.js              (100 lines)
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ claudeClient.js       â—„â”€â”€ LEGACY wrapper (backward compat)
â”‚   â”‚   â”œâ”€â”€ docGenerator.js       â—„â”€â”€ UPDATED: Use injected provider
â”‚   â”‚   â”œâ”€â”€ codeParser.js         (unchanged)
â”‚   â”‚   â””â”€â”€ qualityScorer.js      (unchanged)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ api.js                â—„â”€â”€ UPDATED: Inject provider
â”‚   â””â”€â”€ middleware/
â”‚       â””â”€â”€ llmProvider.js        â—„â”€â”€ NEW: Provider injection
â””â”€â”€ __tests__/
    â”œâ”€â”€ llm/                      â—„â”€â”€ NEW: Provider tests
    â”‚   â”œâ”€â”€ providers/
    â”‚   â”‚   â”œâ”€â”€ base/
    â”‚   â”‚   â”‚   â”œâ”€â”€ BaseLLMProvider.test.js
    â”‚   â”‚   â”‚   â”œâ”€â”€ LLMError.test.js
    â”‚   â”‚   â”‚   â””â”€â”€ RetryHelper.test.js
    â”‚   â”‚   â”œâ”€â”€ anthropic/
    â”‚   â”‚   â”‚   â””â”€â”€ ClaudeProvider.test.js
    â”‚   â”‚   â””â”€â”€ openai/
    â”‚   â”‚       â””â”€â”€ OpenAIProvider.test.js
    â”‚   â”œâ”€â”€ factory/
    â”‚   â”‚   â””â”€â”€ LLMFactory.test.js
    â”‚   â””â”€â”€ integration/
    â”‚       â”œâ”€â”€ provider-switching.test.js
    â”‚       â””â”€â”€ streaming.test.js
    â”œâ”€â”€ claudeClient.test.js      (keep for legacy)
    â””â”€â”€ docGenerator.test.js      (update with mocks)
```

**New Code Statistics:**
- Base classes: ~310 lines
- ClaudeProvider: ~250 lines (refactored from claudeClient)
- OpenAIProvider: ~200 lines (new)
- Factory + Config: ~250 lines
- Tests: ~1,500 lines
- **Total: ~2,510 lines** (~1,200 new + ~300 refactored + ~1,500 tests)

---

## Design Patterns Applied

### 1. Strategy Pattern
```
Context: DocGeneratorService
Strategy Interface: BaseLLMProvider
Concrete Strategies: ClaudeProvider, OpenAIProvider, AzureOpenAIProvider

DocGeneratorService doesn't care WHICH provider it uses,
just that it implements generate() and generateWithStreaming().
```

### 2. Factory Pattern
```
Factory: LLMFactory
Products: ClaudeProvider, OpenAIProvider, etc.

Factory encapsulates provider creation logic.
Client code just says "give me a provider" without knowing HOW it's created.
```

### 3. Adapter Pattern
```
Adaptee: Anthropic SDK (specific API)
Target: BaseLLMProvider (common interface)
Adapter: ClaudeProvider (translates Anthropic API to common interface)

Each provider ADAPTS its SDK's API to the common BaseLLMProvider interface.
```

### 4. Dependency Injection
```
Dependent: DocGeneratorService
Dependency: BaseLLMProvider (interface, not concrete class)

DocGeneratorService receives provider via constructor (not new ClaudeClient()).
Makes it testable (inject mock) and flexible (switch providers).
```

### 5. Singleton Pattern
```
LLMFactory maintains a singleton instance of each provider+model combination.
Prevents creating multiple SDK clients for the same provider.
Improves performance (connection pooling, etc.).
```

---

## Quick Reference Card

### Switching Providers

**Via Environment Variables (server/.env):**
```bash
# Use Claude (default)
LLM_PROVIDER=anthropic
LLM_API_KEY=$CLAUDE_API_KEY
LLM_MODEL=claude-sonnet-4-5-20250929

# Use OpenAI
LLM_PROVIDER=openai
LLM_API_KEY=$OPENAI_API_KEY
LLM_MODEL=gpt-4-turbo-preview

# Use Azure OpenAI
LLM_PROVIDER=azure-openai
LLM_API_KEY=$AZURE_OPENAI_API_KEY
LLM_MODEL=gpt-4
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com
```

**Via API Headers (per-request override):**
```bash
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -H "X-LLM-Provider: openai" \
  -H "X-LLM-Model: gpt-4-turbo-preview" \
  -d '{"code": "...", "docType": "README"}'
```

### Provider Capabilities Matrix

| Provider | Streaming | Caching | Vision | Max Context | Cost (input) | Cost (output) |
|----------|-----------|---------|--------|-------------|--------------|---------------|
| **Claude Sonnet 4.5** | âœ… Yes | âœ… Yes | âœ… Yes | 200K tokens | $0.003/1K | $0.015/1K |
| **OpenAI GPT-4 Turbo** | âœ… Yes | âŒ No | âœ… Yes | 128K tokens | $0.01/1K | $0.03/1K |
| **Azure OpenAI** | âœ… Yes | âŒ No | âœ… Yes | 128K tokens | $0.01/1K | $0.03/1K |
| **AWS Bedrock (Claude)** | âœ… Yes | âš ï¸ Partial | âœ… Yes | 200K tokens | $0.003/1K | $0.015/1K |

### Common Tasks

**Add a new provider:**
1. Create `llm/providers/{name}/{Name}Provider.js`
2. Extend `BaseLLMProvider`
3. Implement `generate()`, `generateWithStreaming()`, `getCapabilities()`
4. Register in `LLMFactory`: `this.registry.set('name', NameProvider)`
5. Write tests

**Test with different provider:**
```bash
LLM_PROVIDER=openai npm run dev
```

**Check which provider is active:**
```javascript
const provider = llmFactory.createFromEnv()
console.log(provider.getProviderName())  // 'claude' or 'openai'
console.log(provider.getModel())         // 'claude-sonnet-4-5-20250929'
```

**Mock provider in tests:**
```javascript
const mockProvider = {
  generate: jest.fn().mockResolvedValue({
    text: 'Mock documentation',
    metadata: { provider: 'mock', inputTokens: 100 }
  }),
  generateWithStreaming: jest.fn(),
  getProviderName: () => 'mock'
}

const docGenerator = new DocGeneratorService(mockProvider)
```

---

## Implementation Timeline

| Phase | Duration | Key Deliverables |
|-------|----------|------------------|
| **Phase 1-2** | 4-5 hours | Base abstraction + Claude refactor |
| **Phase 3** | 1-2 hours | Factory + Config |
| **Phase 4-5** | 2 hours | Update DocGenerator + API routes |
| **Phase 6** | 2 hours | Add OpenAI provider |
| **Phase 7** | 2 hours | Comprehensive testing |
| **Phase 8** | 1 hour | Documentation + deployment |
| **Total** | **12-14 hours** | Multi-provider support complete |

---

## Success Metrics

âœ… **Functionality:**
- All existing tests pass (no breaking changes)
- Can switch providers via environment variable
- Can switch providers via API header
- Streaming works with all providers
- Error handling consistent across providers

âœ… **Quality:**
- 95%+ test coverage for provider layer
- < 5% performance overhead
- Zero production errors

âœ… **Developer Experience:**
- Adding new provider takes < 2 hours
- Clear documentation
- Easy to understand code structure

âœ… **Cost Optimization:**
- Caching works with Claude (24% savings)
- Can route to cheaper providers when appropriate

---

**Ready to implement? See [MULTI-PROVIDER-IMPLEMENTATION-PROMPT.md](./MULTI-PROVIDER-IMPLEMENTATION-PROMPT.md) for step-by-step guide.**
