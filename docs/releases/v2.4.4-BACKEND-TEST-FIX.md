# v2.4.4 Backend Test Fix

**Date:** November 2, 2025
**Status:** ✅ Complete - All Tests Passing

---

## Problem

Backend test suite was failing with error:

```
TypeError: argument handler must be a function

  18 | router.post(
     |        ^
  19 |   '/sales',
  20 |   requireAuth,
  21 |   validateBody({

  at Route.<computed> [as post] (node_modules/router/lib/route.js:228:15)
  at Object.post (src/routes/contact.js:18:8)
  at Object.require (src/routes/__tests__/contact.test.js:11:23)
```

---

## Root Cause

The `contact.test.js` file was written using **CommonJS** (`require`) syntax, but the `contact.js` route file uses **ES modules** (`import/export`). This caused the middleware imports to fail when the route file was loaded during test execution.

**Incorrect (CommonJS):**
```javascript
const request = require('supertest');
const contactRouter = require('../contact');
const { requireAuth, validateBody } = require('../../middleware/auth');
```

**Issue:** ES module routes can't be imported by CommonJS test files in Jest.

---

## Solution

### 1. Convert Test File to ES Modules

Updated imports to use ES module syntax:

```javascript
import { describe, it, expect, beforeEach, jest } from '@jest/globals';
import request from 'supertest';
import express from 'express';

// Mock dependencies BEFORE importing routes
jest.mock('../../middleware/auth.js', () => ({
  requireAuth: jest.fn((req, res, next) => next()),
  validateBody: jest.fn((schema) => {
    capturedState.schema = schema;
    return (req, res, next) => next();
  }),
}));

// Now import routes
import contactRouter from '../contact.js';
import { requireAuth, validateBody } from '../../middleware/auth.js';
```

**Key Points:**
- Mock dependencies **before** importing routes (so mocks are in place when route module loads)
- Use manual mock implementations (Jest's automatic mocks don't provide function implementations)
- Capture schema passed to `validateBody` for test assertions

### 2. Fix Name Trimming Logic

**Issue:** Multiple whitespace in names wasn't being normalized.

**Before:**
```javascript
userName = `${user.first_name} ${user.last_name}`.trim();
// "  John  " + " " + "  Doe  " → "  John     Doe  " → "John     Doe" ❌
```

**After:**
```javascript
userName = `${user.first_name.trim()} ${user.last_name.trim()}`;
// "John" + " " + "Doe" → "John Doe" ✅
```

### 3. Fix Test Assertions

Updated test to match corrected behavior:

```javascript
it('should trim whitespace from database name', async () => {
  mockUser.first_name = '  John  ';
  mockUser.last_name = '  Doe  ';

  expect(sendContactSalesEmail).toHaveBeenCalledWith(
    expect.objectContaining({
      userName: 'John Doe', // Each part trimmed individually ✅
    })
  );
});
```

### 4. Schema Validation Tests

Since `validateBody` is called at route module load time (not during test execution), we can't use `expect().toHaveBeenCalledWith()`. Instead, capture the schema in the mock factory:

```javascript
// Capture schema when route loads
const capturedState = { schema: null };

jest.mock('../../middleware/auth.js', () => ({
  validateBody: jest.fn((schema) => {
    capturedState.schema = schema; // Save for test assertions
    return (req, res, next) => next();
  }),
}));

// Test against captured schema
it('should validate tier is required', async () => {
  expect(capturedState.schema).toMatchObject({
    tier: { required: true, type: 'string' },
  });
});
```

---

## Test Results

### Before Fix
```
FAIL src/routes/__tests__/contact.test.js
  ● Test suite failed to run
    TypeError: argument handler must be a function
```

### After Fix
```
PASS src/routes/__tests__/contact.test.js
  Contact Sales Routes
    POST /api/contact/sales
      Authentication
        ✓ should require authentication
      Tier Validation
        ✓ should accept enterprise tier
        ✓ should accept team tier
        ✓ should reject invalid tier (pro)
        ✓ should reject invalid tier (free)
        ✓ should handle case-insensitive tier names
      Name Resolution - User Has Name
        ✓ should use database name when user has full name
        ✓ should use database name even if form name provided
        ✓ should trim whitespace from database name
      Name Resolution - User Missing Name
        ✓ should use form name when user has no name
        ✓ should trim whitespace from form name
        ✓ should handle empty string when no name provided
        ✓ should use partial name from database if available
        ✓ should use last name only if first name missing
      Email Sending
        ✓ should send email with all user details
        ✓ should include empty message if not provided
        ✓ should use "free" as default tier if user has no tier
        ✓ should return success message after sending email
        ✓ should log inquiry to console
      Error Handling
        ✓ should handle Resend rate limit errors
        ✓ should return 500 for general email sending errors
        ✓ should suggest direct email contact on error
        ✓ should log errors to console
      Request Body Validation
        ✓ should validate tier is required
        ✓ should validate tier is string type
        ✓ should allow optional message field
        ✓ should allow optional firstName field
        ✓ should allow optional lastName field

Test Suites: 1 passed
Tests:       28 passed, 28 total
```

---

## Final Backend Test Count

**Before:**
- Tests: 522 passed | 21 skipped (543 total)

**After (Contact Sales Tests):**
- Tests: 550 passed | 21 skipped (571 total)
- **Added 28 tests** from contact.test.js

**After (Coverage Fix):**
- Tests: 574 passed | 21 skipped (595 total)
- **Added 24 tests** for emailService.js sendContactSalesEmail function
- **Coverage improved**: 87.65% → 91.83% (statements)

**All Backend Tests:**
```
Test Suites: 1 skipped, 23 passed, 23 of 24 total
Tests:       21 skipped, 574 passed, 595 total
```

---

## Files Modified

1. **server/src/routes/__tests__/contact.test.js**
   - Converted from CommonJS to ES modules
   - Fixed all mock references
   - Updated test assertions

2. **server/src/routes/contact.js**
   - Fixed name trimming logic (line 44)

---

## Key Learnings

### ES Modules in Jest

1. **Mock before import:** Jest mocks must be defined before importing the module under test
2. **Manual mocks required:** Automatic mocks don't provide function implementations for ES modules
3. **Use objects for captured state:** Avoid TDZ (Temporal Dead Zone) errors with `const obj = { value: null }`

### Testing Middleware

When middleware is called at module load time (not test runtime):
- Can't use `expect().toHaveBeenCalledWith()` directly
- Capture arguments in mock factory function
- Assert against captured values in tests

### Name/String Normalization

Always trim **each part** of concatenated strings, not just the final result:
```javascript
✅ `${part1.trim()} ${part2.trim()}`  // Each part trimmed
❌ `${part1} ${part2}`.trim()         // Only ends trimmed
```

---

## Related Documentation

- [contact.test.js](../../server/src/routes/__tests__/contact.test.js) - Full test file
- [contact.js](../../server/src/routes/contact.js) - Contact Sales route
- [v2.4.4-TEST-COVERAGE-SUMMARY.md](./v2.4.4-TEST-COVERAGE-SUMMARY.md) - Complete v2.4.4 test coverage

---

**Status:** ✅ All backend tests passing - Ready for v2.4.4 release
