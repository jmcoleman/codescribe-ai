
> server@2.7.4 test
> jest

PASS src/services/__tests__/docGenerator.test.js
  DocGeneratorService
    Constructor
      ✓ should create an instance (4 ms)
    generateDocumentation()
      ✓ should generate README documentation successfully (5 ms)
      ✓ should parse code with correct language (1 ms)
      ✓ should use default language if not specified (1 ms)
      ✓ should build prompt with correct parameters (1 ms)
      ✓ should call Claude API for generation (1 ms)
      ✓ should calculate quality score with documentation and analysis
      ✓ should support streaming generation
      ✓ should not use streaming if onChunk is not provided (1 ms)
      ✓ should generate JSDOC documentation (1 ms)
      ✓ should generate API documentation (1 ms)
      ✓ should generate ARCHITECTURE documentation
      ✓ should default to README for unknown docType
      ✓ should handle empty code gracefully (1 ms)
      ✓ should include timestamp in metadata (1 ms)
      ✓ should propagate parseCode errors (13 ms)
      ✓ should propagate Claude API errors
      ✓ should handle quality scoring errors gracefully (6 ms)
    buildPrompt()
      ✓ should build README prompt with correct structure (1 ms)
      ✓ should build JSDOC prompt with correct structure
      ✓ should build API prompt with correct structure
      ✓ should build ARCHITECTURE prompt with correct structure (1 ms)
      ✓ should include code analysis in prompt
      ✓ should handle no exports
      ✓ should handle unknown complexity
      ✓ should default to README prompt for unknown docType
      ✓ should properly escape code in prompt
      ✓ should include language in code fence
    Integration with dependencies
      ✓ should call all dependencies in correct order (5 ms)
      ✓ should pass streaming callback correctly (9 ms)
    Edge Cases
      ✓ should handle very large code files (1 ms)
      ✓ should handle code with no structure (1 ms)
      ✓ should handle multiple options simultaneously

  console.log
    ┌─────────┬──────────────────────┬────────────────┬───────────┬─────────────┬───────────┬─────────┬────────────┬────┐
    │ (index) │ Name                 │ Type           │ Code Size │ Prompt Size │ Functions │ Classes │ Complexity │ CC │
    ├─────────┼──────────────────────┼────────────────┼───────────┼─────────────┼───────────┼─────────┼────────────┼────┤
    │ 0       │ 'Simple Utils'       │ 'README'       │ 496       │ 4245        │ 3         │ 0       │ 'medium'   │ 3  │
    │ 1       │ 'Auth Service'       │ 'README'       │ 1930      │ 5674        │ 8         │ 1       │ 'medium'   │ 4  │
    │ 2       │ 'Simple Utils JSDoc' │ 'JSDOC'        │ 496       │ 1539        │ 3         │ 0       │ 'medium'   │ 3  │
    │ 3       │ 'Auth Service JSDoc' │ 'JSDOC'        │ 1930      │ 2968        │ 8         │ 1       │ 'medium'   │ 4  │
    │ 4       │ 'REST API'           │ 'API'          │ 3266      │ 7640        │ 5         │ 0       │ 'medium'   │ 18 │
    │ 5       │ 'Auth Architecture'  │ 'ARCHITECTURE' │ 1930      │ 4504        │ 8         │ 1       │ 'medium'   │ 4  │
    └─────────┴──────────────────────┴────────────────┴───────────┴─────────────┴───────────┴─────────┴────────────┴────┘

      at Object.table (tests/integration/prompt-quality.test.js:537:15)

  console.log
    ┌─────────┬────┬──────────────┬────────────────┐
    │ (index) │ #  │ Language     │ Monaco Support │
    ├─────────┼────┼──────────────┼────────────────┤
    │ 0       │ 1  │ 'javascript' │ '✓'            │
    │ 1       │ 2  │ 'typescript' │ '✓'            │
    │ 2       │ 3  │ 'python'     │ '✓'            │
    │ 3       │ 4  │ 'java'       │ '✓'            │
    │ 4       │ 5  │ 'csharp'     │ '✓'            │
    │ 5       │ 6  │ 'cpp'        │ '✓'            │
    │ 6       │ 7  │ 'go'         │ '✓'            │
    │ 7       │ 8  │ 'rust'       │ '✓'            │
    │ 8       │ 9  │ 'php'        │ '✓'            │
    │ 9       │ 10 │ 'ruby'       │ '✓'            │
    │ 10      │ 11 │ 'swift'      │ '✓'            │
    │ 11      │ 12 │ 'kotlin'     │ '✓'            │
    │ 12      │ 13 │ 'scala'      │ '✓'            │
    │ 13      │ 14 │ 'r'          │ '✓'            │
    │ 14      │ 15 │ 'sql'        │ '✓'            │
    │ 15      │ 16 │ 'html'       │ '✓'            │
    │ 16      │ 17 │ 'css'        │ '✓'            │
    │ 17      │ 18 │ 'json'       │ '✓'            │
    │ 18      │ 19 │ 'yaml'       │ '✓'            │
    │ 19      │ 20 │ 'markdown'   │ '✓'            │
    │ 20      │ 21 │ 'xml'        │ '✓'            │
    │ 21      │ 22 │ 'shell'      │ '✓'            │
    │ 22      │ 23 │ 'bash'       │ '✓'            │
    │ 23      │ 24 │ 'powershell' │ '✓'            │
    └─────────┴────┴──────────────┴────────────────┘

      at Object.table (tests/integration/prompt-quality.test.js:669:15)

  console.log
    ┌────────────┬───────┬────────────┬─────────────────────┐
    │ (index)    │ lines │ renderTime │ recommendation      │
    ├────────────┼───────┼────────────┼─────────────────────┤
    │ smallFile  │ 50    │ '< 10ms'   │ 'Direct render'     │
    │ mediumFile │ 500   │ '< 50ms'   │ 'Direct render'     │
    │ largeFile  │ 5000  │ '< 200ms'  │ 'Virtual scrolling' │
    │ hugeFile   │ 50000 │ '< 1s'     │ 'Split/lazy load'   │
    └────────────┴───────┴────────────┴─────────────────────┘

      at Object.table (tests/integration/prompt-quality.test.js:767:15)

PASS tests/integration/prompt-quality.test.js
  Prompt Quality Integration Tests
    README Template Quality
      ✓ should generate comprehensive README for simple utility functions (9 ms)
      ✓ should generate comprehensive README for complex class (3 ms)
    JSDoc Template Quality
      ✓ should generate JSDoc for utility functions (1 ms)
      ✓ should generate JSDoc for class methods (4 ms)
    API Template Quality
      ✓ should generate API documentation for REST endpoints (19 ms)
    ARCHITECTURE Template Quality
      ✓ should generate architecture documentation for auth service (4 ms)
    Code Analysis Context Verification
      ✓ should include comprehensive analysis context in all prompts (10 ms)
      ✓ should format context correctly in prompts (2 ms)
    Prompt Refinement Analysis
      ✓ should analyze prompt effectiveness metrics (36 ms)
    Monaco Editor Syntax Highlighting Requirements
      ✓ should instruct Claude to generate code blocks with language identifiers (1 ms)
      ✓ should support multiple language syntax highlighting in prompts (1 ms)
      ✓ should format JSDoc code blocks for syntax highlighting
      ✓ should format API documentation code examples for syntax highlighting (2 ms)
      ✓ should test Monaco Editor language support matrix (2 ms)
      ✓ should verify code block formatting standards for Monaco rendering
      ✓ should test syntax highlighting for inline code vs code blocks
      ✓ should verify theme compatibility (light/dark modes) (1 ms)
      ✓ should test special character escaping for Monaco rendering
      ✓ should verify long code block performance considerations
      ✓ should verify accessibility features for syntax highlighted code
    Edge Cases and Refinement Opportunities
      ✓ should handle code with no exports gracefully (1 ms)
      ✓ should handle code with many dependencies
      ✓ should handle async/await patterns (1 ms)

PASS src/routes/__tests__/contact.test.js
  Contact Sales Routes
    POST /api/contact/sales
      Authentication
        ✓ should require authentication (28 ms)
      Tier Validation
        ✓ should accept enterprise tier (4 ms)
        ✓ should accept team tier (3 ms)
        ✓ should reject invalid tier (pro) (4 ms)
        ✓ should reject invalid tier (free) (6 ms)
        ✓ should handle case-insensitive tier names (3 ms)
      Name Resolution - User Has Name
        ✓ should use database name when user has full name (2 ms)
        ✓ should use database name even if form name provided (3 ms)
        ✓ should trim whitespace from database name (2 ms)
      Name Resolution - User Missing Name
        ✓ should use form name when user has no name (2 ms)
        ✓ should trim whitespace from form name (2 ms)
        ✓ should handle empty string when no name provided (1 ms)
        ✓ should use partial name from database if available (4 ms)
        ✓ should use last name only if first name missing (1 ms)
      Email Sending
        ✓ should send email with all user details (3 ms)
        ✓ should include empty message if not provided (4 ms)
        ✓ should use "free" as default tier if user has no tier (1 ms)
        ✓ should return success message after sending email (2 ms)
        ✓ should log inquiry to console (1 ms)
      Error Handling
        ✓ should handle Resend rate limit errors (1 ms)
        ✓ should return 500 for general email sending errors (1 ms)
        ✓ should suggest direct email contact on error (2 ms)
        ✓ should log errors to console (2 ms)
      Request Body Validation
        ✓ should validate tier is required
        ✓ should validate tier is string type
        ✓ should allow optional message field (2 ms)
        ✓ should allow optional firstName field (2 ms)
        ✓ should allow optional lastName field (4 ms)
    POST /api/contact/support
      Authentication
        ✓ should require authentication (4 ms)
      Support Requests
        ✓ should send support request for authenticated user (3 ms)
        ✓ should handle user with partial name (1 ms)
        ✓ should use "free" as default tier if user has no tier (2 ms)
      Subject Validation
        ✓ should accept valid subject categories (9 ms)
        ✓ should reject invalid subject category (1 ms)
        ✓ should handle case-insensitive subject names (1 ms)
      Error Handling
        ✓ should handle Resend rate limit errors (1 ms)
        ✓ should return 500 for general email sending errors (1 ms)
        ✓ should suggest direct email contact on error
        ✓ should log errors to console (2 ms)
      Logging
        ✓ should log support request to console
      File Attachments
        ✓ should accept support request without attachments (4 ms)
        ✓ should accept support request with single attachment (2 ms)
        ✓ should accept support request with multiple attachments (1 ms)
        ✓ should log attachment count when files are attached (1 ms)
        ✓ should handle file type validation errors (7 ms)

PASS src/routes/__tests__/auth-password-reset.test.js
  Password Reset Flow
    POST /api/auth/forgot-password
      Request Validation
        ✓ should reject request without email (13 ms)
        ✓ should reject invalid email format (2 ms)
        ✓ should accept valid email format (2 ms)
      Email Enumeration Protection
        ✓ should return same success message for non-existent user (2 ms)
        ✓ should return same success message for existing user (2 ms)
        ✓ should not reveal user existence through timing (10 ms)
      OAuth User Account Linking
        ✓ should allow OAuth-only users to add password via reset flow (2 ms)
        ✓ should send email for email/password users (3 ms)
      Token Generation
        ✓ should generate secure random token (2 ms)
        ✓ should set token expiration to 1 hour (2 ms)
        ✓ should generate unique tokens for multiple requests (1 ms)
      Error Handling
        ✓ should handle database errors gracefully (2 ms)
        ✓ should handle email service errors gracefully (1 ms)
    POST /api/auth/reset-password
      Request Validation
        ✓ should reject request without token (1 ms)
        ✓ should reject request without password (3 ms)
        ✓ should reject password shorter than 8 characters (1 ms)
        ✓ should reject token shorter than 32 characters (1 ms)
      Token Validation
        ✓ should reject invalid token (3 ms)
        ✓ should reject expired token (1 ms)
        ✓ should accept valid non-expired token (2 ms)
      Password Reset
        ✓ should update user password (2 ms)
        ✓ should clear reset token after successful reset (1 ms)
        ✓ should return success message (1 ms)
      OAuth User Account Linking
        ✓ should allow OAuth users to set password (account linking) (1 ms)
      Error Handling
        ✓ should handle database errors during token lookup (1 ms)
        ✓ should handle errors during password update (1 ms)
    End-to-End Flow
      ✓ should complete full password reset flow (3 ms)
      ✓ should prevent token reuse (3 ms)

PASS src/routes/__tests__/email-verification.test.js
  Email Verification Routes
    POST /api/auth/verify-email
      ✓ should verify email with valid token (26 ms)
      ✓ should return 400 for invalid token (4 ms)
      ✓ should return 400 for expired token (2 ms)
      ✓ should return 400 when token is missing (3 ms)
      ✓ should return 400 when token is empty string (5 ms)
      ✓ should handle database errors gracefully (2 ms)
      ✓ should handle verification update errors (2 ms)
      ✓ should sanitize user data in response (1 ms)
    POST /api/auth/resend-verification
      ✓ should resend verification email for unverified user (5 ms)
      ✓ should return 400 if email already verified (2 ms)
      ✓ should return 401 without authentication (1 ms)
      ✓ should return 401 if user not found (2 ms)
      ✓ should handle token creation errors (1 ms)
      ✓ should handle email sending errors but still succeed (2 ms)
      ✓ should use correct email address from user object (3 ms)
    Verification Flow Integration
      ✓ should complete full flow: signup -> resend -> verify (5 ms)
      ✓ should prevent resending after verification (4 ms)
      ✓ should handle concurrent verification attempts (1 ms)
    Security Tests
      ✓ should not leak user existence for invalid tokens (1 ms)
      ✓ should require authentication for resend endpoint
      ✓ should validate token format (not empty) (2 ms)
      ✓ should handle malformed tokens safely (4 ms)
      ✓ should not expose sensitive user data in error messages (2 ms)
    Edge Cases
      ✓ should handle user with null email field (2 ms)
      ✓ should handle user with missing name fields gracefully (1 ms)
      ✓ should handle extremely long tokens (1 ms)
      ✓ should handle special characters in tokens (1 ms)

PASS src/routes/__tests__/cron.test.js
  POST /api/cron/permanent-deletions
    Authentication
      ✓ should reject requests without authorization header (15 ms)
      ✓ should reject requests with invalid Bearer token (3 ms)
      ✓ should reject requests with malformed authorization header (9 ms)
      ✓ should return 500 if CRON_SECRET is not configured (2 ms)
      ✓ should accept requests with valid Bearer token (2 ms)
    Job Execution
      ✓ should execute permanent deletion job successfully with no users (1 ms)
      ✓ should execute permanent deletion job successfully with users deleted (2 ms)
      ✓ should handle partial deletion failures (3 ms)
      ✓ should return timestamp in ISO 8601 format (5 ms)
      ✓ should measure and return execution duration (53 ms)
    Error Handling
      ✓ should handle job execution errors gracefully (2 ms)
      ✓ should handle unexpected errors during job execution (1 ms)
      ✓ should return timestamp even on error (1 ms)
      ✓ should return execution duration even on error (22 ms)
    Integration scenarios
      ✓ should handle large batch deletions (1 ms)
      ✓ should handle mixed success and failure results (2 ms)
      ✓ should provide complete response format for successful job (1 ms)
      ✓ should provide complete response format for failed job (1 ms)

PASS tests/integration/password-reset-flow.test.js
  Password Reset Flow Integration Tests
    POST /api/auth/forgot-password - Request Password Reset
      ✓ should send reset email for existing user (15 ms)
      ✓ should handle OAuth-only user (no password_hash) (6 ms)
      ✓ should return success even for non-existent email (security) (2 ms)
      ✓ should rate limit password reset requests (5 ms)
      ✓ should return success even when email service fails (security) (2 ms)
      ✓ should return success even on database errors (security) (3 ms)
    POST /api/auth/reset-password - Complete Password Reset
      ✓ should reset password with valid token (3 ms)
      ✓ should handle OAuth-only user adding password (2 ms)
      ✓ should reject invalid reset token (1 ms)
      ✓ should reject expired reset token (1 ms)
      ✓ should reject short token (validation) (1 ms)
      ✓ should handle database errors gracefully (2 ms)
    Complete Password Reset Flow
      ✓ should handle full password reset journey (3 ms)

PASS src/routes/__tests__/migrate.test.js
  Migration Endpoints
    GET /api/migrate/status
      Success Cases
        ✓ should return migration status with all migrations applied (8 ms)
        ✓ should show pending migrations correctly (2 ms)
        ✓ should show applied migrations with timestamps (1 ms)
        ✓ should include database version information (3 ms)
        ✓ should work with no migrations (1 ms)
        ✓ should work with all migrations applied (2 ms)
      Error Cases
        ✓ should handle database connection errors gracefully (5 ms)
        ✓ should hide error details in production (1 ms)
        ✓ should show error details in development (2 ms)
    POST /api/migrate/run - Authentication
      Authentication Failures
        ✓ should reject requests without Authorization header (2 ms)
        ✓ should reject requests with malformed Authorization header (2 ms)
        ✓ should reject requests with wrong secret (2 ms)
        ✓ should reject when MIGRATION_SECRET is not configured (2 ms)
        ✓ should be case-sensitive for Bearer keyword (1 ms)
      Authentication Success
        ✓ should accept requests with valid Bearer token (2 ms)
        ✓ should work with secrets containing special characters (2 ms)
    POST /api/migrate/run - Status Action
      ✓ should return detailed status when action is "status" (1 ms)
      ✓ should include execution time in status action (1 ms)
      ✓ should not run migrations when action is "status" (1 ms)
    POST /api/migrate/run - Run Migrations
      Success Cases
        ✓ should run pending migrations successfully (1 ms)
        ✓ should handle no pending migrations (1 ms)
        ✓ should apply multiple pending migrations (1 ms)
      Error Cases
        ✓ should handle migration execution errors (2 ms)
        ✓ should handle database connection errors during run (1 ms)
        ✓ should hide error details in production (2 ms)
    Integration Tests
      ✓ should have consistent migration counts between status endpoints (1 ms)
      ✓ should increment applied migrations count after running migrations (5 ms)

PASS tests/integration/settings.test.js
  Settings API Integration Tests
    PATCH /api/auth/password
      ✓ should successfully change password with valid current password (4 ms)
      ✓ should reject password change with incorrect current password (1 ms)
      ✓ should reject password change for OAuth users (2 ms)
      ✓ should reject password change without authentication (1 ms)
      ✓ should validate new password length (1 ms)
      ✓ should require both passwords (1 ms)
    PATCH /api/auth/preferences
      ✓ should successfully update analytics preference to false (2 ms)
      ✓ should successfully update analytics preference to true (1 ms)
      ✓ should reject preference update without authentication (1 ms)
      ✓ should validate analytics_enabled is boolean (1 ms)
      ✓ should require analytics_enabled field (1 ms)
    DELETE /api/auth/account
      ✓ should reject deletion without confirmation text (2 ms)
      ✓ should reject deletion without authentication (1 ms)
      ✓ should successfully delete account with FREE tier (no Stripe) (1 ms)
      ✓ should cancel Stripe subscription before deleting paid account (2 ms)
      ✓ should handle Stripe cancellation errors gracefully (2 ms)
      ✓ should skip Stripe cancellation if no active subscriptions (2 ms)

PASS src/services/__tests__/emailService.test.js
  Email Service
    sendPasswordResetEmail
      ✓ should send email with correct recipient (1 ms)
      ✓ should include reset link with token in email
      ✓ should include correct subject line
      ✓ should use correct from address
      ✓ should include expiration warning in email
      ✓ should include security message (1 ms)
      ✓ should return email ID on success
      ✓ should throw error on email service failure (15 ms)
      ✓ should handle Resend rate limit errors (429)
      ✓ should handle rate limit errors by message content (1 ms)
      ✓ should log email sending
      ✓ should handle special characters in email
      ✓ should use CLIENT_URL from environment
    sendVerificationEmail
      ✓ should send email with correct recipient
      ✓ should include verification link with token (1 ms)
      ✓ should include correct subject line
      ✓ should include welcome message
      ✓ should include expiration warning (24 hours)
      ✓ should return email ID on success
      ✓ should throw error on email service failure
      ✓ should handle Resend rate limit errors (429) (1 ms)
      ✓ should handle rate limit errors by message content
      ✓ should log email sending (1 ms)
    Email Template Quality
      ✓ should include CodeScribe AI branding in password reset
      ✓ should include CodeScribe AI branding in verification
      ✓ should include clickable button in password reset
      ✓ should include plain text link as fallback
      ✓ should be mobile responsive
      ✓ should use brand colors (purple/indigo)
    Error Logging
      ✓ should log errors when password reset email fails (1 ms)
      ✓ should log errors when verification email fails
    sendContactSalesEmail
      ✓ should send email to sales@codescribeai.com
      ✓ should include replyTo with user email
      ✓ should include correct subject line with "Sales Inquiry" prefix (1 ms)
      ✓ should use email in subject when name not provided and no subject given
      ✓ should use "Sales Inquiry" prefix regardless of tier
      ✓ should include user name in email HTML
      ✓ should display "Not provided" when userName is empty
      ✓ should include user email in HTML
      ✓ should include user ID in HTML
      ✓ should include current tier badge in HTML
      ✓ should include interested tier in HTML
      ✓ should include user message when provided (1 ms)
      ✓ should omit message section when message is empty
      ✓ should omit message section when message is not provided
      ✓ should return email ID on success (1 ms)
      ✓ should log email details on success (1 ms)
      ✓ should throw error on email service failure
      ✓ should log error details on failure
      ✓ should handle Resend rate limit errors (429)
      ✓ should handle rate limit errors by message content
      ✓ should use user name in from field when provided
      ✓ should use FROM_EMAIL when user name not provided
      ✓ should handle special characters in user name
      ✓ should handle special characters in message
      ✓ should preserve newlines in message
    sendSupportEmail
      ✓ should send email to support@codescribeai.com (10 ms)
      ✓ should include replyTo with user email
      ✓ should map subject codes to labels correctly (1 ms)
      ✓ should include subject label and user name in subject line
      ✓ should use email in subject when name not provided
      ✓ should use "Support Request" for unknown subject codes
      ✓ should include user name in from field when provided
      ✓ should use FROM_EMAIL when user name not provided
      ✓ should include user name in email HTML (1 ms)
      ✓ should display "Not provided" when userName is empty
      ✓ should include user email in HTML
      ✓ should include user ID when provided
      ✓ should include user ID when provided
      ✓ should include current tier when provided
      ✓ should omit current tier section when not provided
      ✓ should include subject category label in HTML (1 ms)
      ✓ should include user message in HTML
      ✓ should return email ID on success
      ✓ should log email details on success
      ✓ should throw error on email service failure
      ✓ should log error details on failure (1 ms)
      ✓ should handle Resend rate limit errors (429)
      ✓ should handle rate limit errors by message content
      ✓ should handle special characters in user name (1 ms)
      ✓ should handle special characters in message
      ✓ should preserve newlines in message
      ✓ should work for unauthenticated users (no userId or currentTier)
      ✓ should handle all subject categories (1 ms)
      ✓ should handle support request without attachments
      ✓ should include single attachment in email
      ✓ should include multiple attachments in email
    sendDeletionScheduledEmail
      ✓ should send email with correct recipient (1 ms)
      ✓ should include correct subject line
      ✓ should include restore link with token
      ✓ should include formatted deletion date
      ✓ should display user name in greeting
      ✓ should fallback to email username when name not provided
      ✓ should mention 30-day grace period
      ✓ should include restore button CTA (1 ms)
      ✓ should list what data will be deleted
      ✓ should include warning emoji in subject
      ✓ should use correct from address
      ✓ should throw error when email sending fails
      ✓ should include footer with support contact
    sendAccountRestoredEmail
      ✓ should send email with correct recipient (1 ms)
      ✓ should include correct subject line
      ✓ should display user name in greeting
      ✓ should fallback to email username when name not provided
      ✓ should confirm account is active
      ✓ should mention deletion was canceled
      ✓ should include success emoji
      ✓ should include dashboard link CTA
      ✓ should use green gradient for success header
      ✓ should use correct from address (2 ms)
      ✓ should throw error when email sending fails (1 ms)
      ✓ should mention data was preserved
    sendFinalDeletionWarningEmail
      ✓ should send email with correct recipient
      ✓ should include urgent subject line with warning emoji
      ✓ should include restore link with token
      ✓ should display user name in greeting (1 ms)
      ✓ should fallback to email username when name not provided
      ✓ should emphasize 24-hour deadline
      ✓ should use urgent language and styling
      ✓ should use red gradient for urgency
      ✓ should include urgent CTA button
      ✓ should warn data cannot be recovered
      ✓ should use correct from address
      ✓ should throw error when email sending fails
      ✓ should mention automatic deletion if no action taken (1 ms)
    Utility Functions
      shouldMockEmails configuration
        ✓ should mock when MOCK_EMAILS=true
        ✓ should not mock when MOCK_EMAILS=false and API key exists
        ✓ should force mocking when MOCK_EMAILS=false but no API key
        ✓ should mock in development/test when MOCK_EMAILS not set
        ✓ should not mock in production when MOCK_EMAILS not set
      mockEmailSend function
        ✓ should log email details when mocking (1 ms)
        ✓ should log reply-to when provided
        ✓ should extract and log URLs from HTML
        ✓ should return mock response with id
      getResendClient function
        ✓ should force mocking when RESEND_API_KEY not set and MOCK_EMAILS=false
        ✓ should create client when RESEND_API_KEY is set
        ✓ should reuse existing client instance

PASS src/routes/__tests__/legal.test.js
  Legal Routes
    GET /api/legal/versions
      ✓ should return current versions of legal documents (1 ms)
      ✓ should be accessible without authentication (1 ms)
      ✓ should return correct version format (1 ms)
      ✓ should include URLs to legal pages (2 ms)
    GET /api/legal/status
      ✓ should require authentication (2 ms)
      ✓ should return status when user has accepted current versions (1 ms)
      ✓ should return needs_reacceptance: true when user needs to accept terms (1 ms)
      ✓ should return needs_reacceptance: true when user needs to accept privacy (2 ms)
      ✓ should return needs_reacceptance: true when user needs to accept both (6 ms)
      ✓ should return 404 when user not found (2 ms)
      ✓ should include current versions in response (1 ms)
      ✓ should include accepted versions in response (2 ms)
      ✓ should handle database errors gracefully (1 ms)
    POST /api/legal/accept
      ✓ should require authentication (6 ms)
      ✓ should accept legal documents successfully (3 ms)
      ✓ should call User.acceptLegalDocuments with correct parameters (2 ms)
      ✓ should return 400 when accept_terms is false (2 ms)
      ✓ should return 400 when accept_privacy is false (2 ms)
      ✓ should return 400 when both are false (1 ms)
      ✓ should return 400 when accept_terms is missing (2 ms)
      ✓ should return 400 when accept_privacy is missing (2 ms)
      ✓ should return 400 when request body is empty (1 ms)
      ✓ should include required values in error response (1 ms)
      ✓ should handle database errors gracefully (3 ms)
      ✓ should include accepted_at timestamps in response (1 ms)
    Integration - Full Workflow
      ✓ should complete full re-acceptance workflow (2 ms)

PASS src/middleware/__tests__/auth.test.js
  Auth Middleware
    requireAuth
      ✓ should allow request with valid JWT token (2 ms)
      ✓ should reject request without authentication
      ✓ should reject request with invalid token
      ✓ should reject request with expired token (1 ms)
      ✓ should accept token without "Bearer " prefix
      ✓ should prioritize JWT over session (1 ms)
    optionalAuth
      ✓ should attach user if JWT is valid (1 ms)
      ✓ should continue without user if not authenticated
      ✓ should continue if token is invalid
      ✓ should not fail request on auth error
    requireTier
      ✓ should allow access if user has exact required tier
      ✓ should allow access if user has higher tier
      ✓ should reject access if user has lower tier (1 ms)
      ✓ should reject if user is not authenticated
      ✓ should throw error for invalid tier (8 ms)
      ✓ should validate tier hierarchy correctly (1 ms)
    validateBody
      ✓ should pass validation for valid data
      ✓ should reject missing required fields (1 ms)
      ✓ should validate email format (1 ms)
      ✓ should validate password minimum length
      ✓ should validate custom minLength
      ✓ should validate maxLength
      ✓ should skip validation for optional missing fields
      ✓ should validate optional fields if provided
      ✓ should use custom validator function (1 ms)
      ✓ should pass custom validation if valid
      ✓ should handle empty strings as missing
    generateToken
      ✓ should generate valid JWT token (1 ms)
      ✓ should use default expiration of 7 days
      ✓ should accept custom expiration (1 ms)
      ✓ should include user ID in sub claim (1 ms)
    sanitizeUser
      ✓ should remove password_hash from user object
      ✓ should return null for null input
      ✓ should return null for undefined input
      ✓ should not modify original user object
      ✓ should preserve all other fields (1 ms)
    Edge Cases
      ✓ should handle malformed JWT gracefully
      ✓ should handle JWT with wrong secret (1 ms)
      ✓ should handle missing isAuthenticated function
    requireVerifiedEmail
      ✓ should reject request without user
      ✓ should reject request with user missing id

PASS src/jobs/__tests__/permanentDeletionJob.test.js
  Permanent Deletion Cron Job
    processPermanentDeletions()
      ✓ should return zero results when no users are expired (1 ms)
      ✓ should successfully delete all expired users
      ✓ should handle individual deletion failures without stopping batch (1 ms)
      ✓ should handle all deletions failing
      ✓ should throw error if findExpiredDeletions fails (6 ms)
      ✓ should process users in order by deletion_scheduled_at
    startPermanentDeletionJob()
      ✓ should schedule cron job with correct schedule
      ✓ should return cron job instance (1 ms)
      ✓ should not run immediately by default
      ✓ should run immediately when runImmediately option is true (10 ms)
      ✓ should handle errors in immediate run gracefully (12 ms)
      ✓ should call processPermanentDeletions when scheduled callback runs
      ✓ should handle errors in scheduled runs gracefully
    stopPermanentDeletionJob()
      ✓ should stop the cron job
      ✓ should handle null job gracefully
      ✓ should handle undefined job gracefully
      ✓ should handle job without stop method gracefully (1 ms)
    Integration scenarios
      ✓ should complete full lifecycle: start, run, stop
      ✓ should handle large batch of deletions efficiently
      ✓ should provide detailed error information for failed deletions

PASS src/routes/__tests__/api.user-deletion.test.js
  User Deletion & Data Export API
    POST /api/user/delete-account
      ✓ should schedule account deletion with 30-day grace period (3 ms)
      ✓ should accept deletion without reason (1 ms)
      ✓ should handle user not found gracefully (2 ms)
      ✓ should handle email service failure (1 ms)
      ✓ should handle already deleted account (1 ms)
      ✓ should send email with correct user name format (3 ms)
    POST /api/user/restore-account
      ✓ should restore account with valid token (2 ms)
      ✓ should reject request without token (2 ms)
      ✓ should reject invalid token (1 ms)
      ✓ should reject expired token (1 ms)
      ✓ should handle restore failure gracefully (1 ms)
      ✓ should handle email service failure on restore (1 ms)
      ✓ should handle user name with missing last name (1 ms)
    GET /api/user/data-export
      ✓ should export complete user data (3 ms)
      ✓ should set correct response headers for download (1 ms)
      ✓ should generate unique filename with timestamp (3 ms)
      ✓ should handle export failure gracefully (2 ms)
      ✓ should include all required export data fields (2 ms)
      ✓ should handle user with no usage data (1 ms)
      ✓ should export data for user with minimal profile (2 ms)
    Integration: Deletion + Restore Flow
      ✓ should complete full deletion and restore cycle (3 ms)

PASS src/services/__tests__/codeParser.test.js
  CodeParser Service
    ✓ should pass all custom test suite assertions (18 ms)

PASS tests/integration/quality-scoring.test.js
  Quality Scoring Integration
    End-to-end quality assessment
      ✓ should parse code and score documentation (5 ms)
      ✓ should give lower scores for undocumented functions (1 ms)
      ✓ should handle empty code gracefully
      ✓ should recognize well-documented complex code (1 ms)
      ✓ should penalize poor documentation for complex code (1 ms)
      ✓ should provide actionable suggestions
      ✓ should handle syntax errors in code parsing (1 ms)
      ✓ should reward comprehensive documentation of all functions (1 ms)
    Different documentation types
      ✓ should score README documentation (1 ms)
      ✓ should score JSDoc-style documentation

PASS src/models/__tests__/User-deletion.test.js
  User Model - Deletion & Data Export
    scheduleForDeletion
      ✓ should schedule account for deletion with 30-day grace period
      ✓ should include optional deletion reason
      ✓ should throw error if user not found (8 ms)
      ✓ should prevent scheduling deletion for already deleted account (1 ms)
      ✓ should generate unique restore token
    findByRestoreToken
      ✓ should find user by valid restore token
      ✓ should return null for invalid token
      ✓ should not find users without scheduled deletion (1 ms)
      ✓ should not find already deleted accounts
    restoreAccount
      ✓ should restore scheduled deletion and clear restore token
      ✓ should throw error if deletion not scheduled
      ✓ should only restore accounts with scheduled deletion
    findExpiredDeletions
      ✓ should find accounts ready for permanent deletion
      ✓ should return empty array if no expired deletions (1 ms)
      ✓ should order by deletion_scheduled_at ASC
    permanentlyDelete
      ✓ should use tombstone approach: aggregate usage, delete quotas, NULL PII (1 ms)
      ✓ should throw error if user not found
      ✓ should only delete accounts not already deleted (1 ms)
      ✓ should preserve stripe_customer_id for billing dispute resolution
    exportUserData
      ✓ should export complete user data in GDPR-compliant format
      ✓ should include GitHub connection status (1 ms)
      ✓ should include usage history
      ✓ should throw error if user not found
      ✓ should include data retention policy

PASS src/services/__tests__/qualityScorer.test.js
  qualityScorer
    calculateQualityScore
      ✓ should score excellent documentation with A grade (1 ms)
      ✓ should score poor documentation with F grade
      ✓ should handle empty documentation (1 ms)
      ✓ should detect overview section
      ✓ should detect installation section
      ✓ should count code blocks correctly
      ✓ should score API documentation coverage (1 ms)
      ✓ should give full API credit when no functions exist (1 ms)
      ✓ should count markdown headers (1 ms)
      ✓ should detect bullet points in structure
      ✓ should award full structure points for well-formatted docs
      ✓ should assign correct letter grades
      ✓ should provide helpful suggestions
      ✓ should handle missing codeAnalysis gracefully
      ✓ should be case-insensitive for section detection
      ✓ should detect alternative section names
      ✓ should return valid quality score structure
    assessInputCodeQuality (via calculateQualityScore 4th parameter)
      ✓ should assess input code with excellent comments (15%+)
      ✓ should assess input code with good comments (8-15%) (1 ms)
      ✓ should assess input code with minimal comments (3-8%)
      ✓ should assess input code with no comments
      ✓ should assess descriptive naming quality
      ✓ should detect cryptic naming
      ✓ should detect JSDoc documentation
      ✓ should detect Python docstrings
      ✓ should detect minimal existing docs (1 ms)
      ✓ should detect no existing documentation
      ✓ should assess well-structured code
      ✓ should detect poor indentation
      ✓ should detect excessive blank lines
      ✓ should detect overly long lines
      ✓ should calculate improvement delta
      ✓ should return null inputCodeHealth when no inputCode provided
      ✓ should handle empty inputCode string (1 ms)
      ✓ should include all 4 criteria in breakdown
      ✓ should calculate grade based on input code score

PASS src/models/__tests__/Usage.test.js
  Usage Model
    getUserUsage
      ✓ should return usage for authenticated user (1 ms)
      ✓ should return usage for anonymous user by IP
      ✓ should return zeroed stats if no usage record exists (1 ms)
      ✓ should trigger daily reset if needed
    incrementUsage
      ✓ should create new usage record for authenticated user
      ✓ should increment existing usage record
      ✓ should increment usage for anonymous user by IP
      ✓ should support custom increment count (1 ms)
    resetDailyUsage
      ✓ should reset daily counter for authenticated user
      ✓ should reset daily counter for anonymous user
      ✓ should return zeroed stats if no record exists
    resetMonthlyUsage
      ✓ should reset monthly counter for authenticated user
      ✓ should reset monthly counter for anonymous user
    getUsageHistory
      ✓ should return usage history for date range (1 ms)
      ✓ should return empty array if no history exists
    deleteUserUsage
      ✓ should delete all usage records for a user
      ✓ should return false if no records deleted
    getSystemUsageStats
      ✓ should return system-wide statistics
      ✓ should handle null values in statistics
    migrateAnonymousUsage
      ✓ should migrate anonymous usage to user account (1 ms)
      ✓ should merge anonymous usage with existing user usage
      ✓ should return false if no anonymous usage exists (2 ms)
      ✓ should preserve the most recent last_reset_date during migration
    Edge Cases
      ✓ should handle database errors gracefully (8 ms)
      ✓ should handle IPv6 addresses
      ✓ should handle zero usage counts
    Integration Scenarios
      ✓ should support full user lifecycle from anonymous to authenticated (1 ms)
      ✓ should handle daily reset at midnight
      ✓ should handle monthly reset at month start

PASS src/services/__tests__/docGenerator.mermaid.test.js
  DocGeneratorService - Mermaid Diagram Support
    Prompt Generation - Mermaid Instructions
      README prompts
        ✓ should include Mermaid diagram instructions in README prompt
        ✓ should specify flowchart syntax for README
        ✓ should provide Mermaid syntax rules in README prompt
        ✓ should include correct Mermaid example in README prompt (1 ms)
        ✓ should warn against incorrect Mermaid syntax in README prompt
      API prompts
        ✓ should include Mermaid diagram instructions in API prompt
        ✓ should specify sequence diagram syntax for API
        ✓ should provide sequence diagram example in API prompt
        ✓ should explain arrow syntax for sequence diagrams in API prompt (1 ms)
      ARCHITECTURE prompts
        ✓ should include Mermaid diagram instructions in ARCHITECTURE prompt
        ✓ should emphasize diagram importance in ARCHITECTURE prompt
        ✓ should provide architecture-specific Mermaid example
        ✓ should explain database shape syntax in ARCHITECTURE prompt (1 ms)
      JSDOC prompts
        ✓ should NOT include Mermaid instructions in JSDOC prompt
    Documentation Generation with Mermaid Diagrams
      ✓ should handle documentation with Mermaid flowchart
      ✓ should handle documentation with Mermaid sequence diagram (1 ms)
      ✓ should handle documentation with multiple Mermaid diagrams
      ✓ should handle documentation without Mermaid diagrams
      ✓ should preserve Mermaid diagram formatting during streaming
    Mermaid Syntax Validation in Prompts
      ✓ should enforce simple node IDs in all prompts
      ✓ should prohibit incorrect arrow syntax in all prompts
      ✓ should provide correct syntax examples in all prompts (1 ms)
    Edge Cases and Error Handling
      ✓ should handle incomplete Mermaid diagram in documentation
      ✓ should handle Mermaid diagram with syntax errors
      ✓ should handle documentation with only Mermaid diagrams
      ✓ should handle very large Mermaid diagrams
    Language-Specific Mermaid Support
      ✓ should include Mermaid instructions for JavaScript
      ✓ should include Mermaid instructions for TypeScript
      ✓ should include Mermaid instructions for Python (1 ms)
      ✓ should include Mermaid instructions for all supported languages
    Prompt Consistency
      ✓ should consistently format Mermaid instructions across doc types
      ✓ should include code fence format in all Mermaid instructions

PASS tests/integration/file-upload.test.js
  File Upload Validation
    Test fixtures
      ✓ should have valid JavaScript test file
      ✓ should have valid TypeScript test file (1 ms)
      ✓ should have valid JSX test file
      ✓ should have valid TSX test file (1 ms)
      ✓ should have valid Python test file
      ✓ should have plain text test file (now valid)
      ✓ should have large file for size testing (1 ms)
    File extension validation logic
      ✓ should allow all valid extensions
      ✓ should reject invalid extensions
      ✓ should handle uppercase extensions
    File size validation logic
      ✓ should accept files under size limit (1 ms)
      ✓ should identify files over size limit
    File content reading
      ✓ should read UTF-8 content correctly
      ✓ should preserve special characters
      ✓ should handle different line endings (1 ms)
    Response format helper
      ✓ should format bytes correctly
      ✓ should format test file sizes
    Empty file validation (NEW)
      ✓ should detect empty files (0 bytes) (1 ms)
      ✓ should detect files with only whitespace
      ✓ should accept files with content after trimming
    Content length validation (NEW)
      ✓ should accept files under character limit
      ✓ should identify files exceeding character limit (1 ms)
      ✓ should accept files at exactly character limit (1 ms)
    Integration readiness
      ✓ should have all required test fixtures
      ✓ should validate core file types are represented (1 ms)
      ✓ should document all supported file types

PASS src/routes/__tests__/api.usage.test.js
  Usage and Tier API Endpoints
    GET /api/user/usage
      ✓ should return user usage statistics (7 ms)
      ✓ should support anonymous users (IP-based tracking) (2 ms)
      ✓ should handle unlimited tier (2 ms)
    GET /api/user/tier-features
      ✓ should return user tier and features (2 ms)
      ✓ should require authentication (1 ms)
      ✓ should return pro tier features for pro users (2 ms)
    GET /api/tiers
      ✓ should return all tier definitions (public endpoint) (2 ms)
      ✓ should not require authentication (1 ms)
      ✓ should include pricing information for paid tiers (2 ms)
      ✓ should include all tier features (3 ms)

PASS src/middleware/__tests__/tierGate.test.js
  tierGate Middleware
    requireFeature
      ✓ should allow access if feature is available in user tier
      ✓ should deny access if feature is not available in user tier (1 ms)
      ✓ should default to free tier if user not authenticated
    checkUsage
      ✓ should allow request if usage is within limits
      ✓ should deny request if daily limit exceeded
      ✓ should track anonymous users by IP address
      ✓ should check file size from req.file
      ✓ should check file size from req.body.code (1 ms)
    requireTier
      ✓ should allow access if user tier meets minimum requirement
      ✓ should deny access if user tier is below minimum
      ✓ should allow access if user has exact minimum tier
      ✓ should default to free tier if user not authenticated
    addTierHeaders
      ✓ should add tier info to response headers
      ✓ should handle unlimited tiers
      ✓ should track anonymous users by IP (1 ms)
    incrementUsage
      ✓ should increment usage for user ID
      ✓ should increment usage by custom count
      ✓ should increment usage for IP address
    getTierInfoForClient
      ✓ should return sanitized tier info
      ✓ should default to free tier

PASS src/middleware/__tests__/requireTermsAcceptance.test.js
  requireTermsAcceptance Middleware
    When user is not authenticated
      ✓ should skip check and call next() for unauthenticated requests
      ✓ should skip check when req.user is undefined
    When user has accepted current versions
      ✓ should allow request when both terms and privacy are current (1 ms)
    When user needs to re-accept legal documents
      ✓ should return 403 when user has not accepted terms
      ✓ should return 403 when user has not accepted privacy policy
      ✓ should return 403 when user has accepted old terms version
      ✓ should return 403 when user has accepted old privacy version
      ✓ should return 403 when user has not accepted either document
    Response format when re-acceptance required
      ✓ should include missing_acceptance with terms version when terms needs acceptance
      ✓ should include missing_acceptance with privacy version when privacy needs acceptance
      ✓ should include missing_acceptance with both versions when both need acceptance
      ✓ should include current_versions in response (1 ms)
      ✓ should include descriptive message in response
  warnTermsAcceptance Middleware (Warning Mode)
    When user is not authenticated
      ✓ should skip check and call next() for unauthenticated requests
    When user has accepted current versions
      ✓ should not set warning headers when user is current
    When user needs to re-accept legal documents
      ✓ should set warning headers but not block request when terms needs acceptance (1 ms)
      ✓ should set warning headers but not block request when privacy needs acceptance
      ✓ should set warning headers but not block request when both need acceptance (1 ms)
      ✓ should always call next() even when warnings are set
  Edge Cases
    ✓ should handle user with undefined acceptance fields (1 ms)
    ✓ should handle new user with no legal acceptance fields
    ✓ should handle user object with only id

PASS src/constants/__tests__/legalVersions.test.js
  Legal Version Constants
    ✓ should export CURRENT_TERMS_VERSION (1 ms)
    ✓ should export CURRENT_PRIVACY_VERSION
    ✓ should use ISO date format for version numbers
    ✓ should have valid initial versions
  hasAcceptedCurrentTerms()
    ✓ should return true when user has accepted current terms version
    ✓ should return false when user has not accepted terms
    ✓ should return false when user has accepted old terms version
    ✓ should return false when user has no terms_version_accepted field
    ✓ should handle undefined user gracefully
  hasAcceptedCurrentPrivacy()
    ✓ should return true when user has accepted current privacy version
    ✓ should return false when user has not accepted privacy policy (1 ms)
    ✓ should return false when user has accepted old privacy version
    ✓ should return false when user has no privacy_version_accepted field
    ✓ should handle undefined user gracefully
  needsLegalReacceptance()
    ✓ should return all false when user has accepted both current versions
    ✓ should return needsTerms: true when terms not accepted
    ✓ should return needsPrivacy: true when privacy not accepted
    ✓ should return all true when neither is accepted
    ✓ should return needsTerms: true when old terms version accepted
    ✓ should return needsPrivacy: true when old privacy version accepted
    ✓ should handle user with no acceptance fields
    ✓ should handle user with undefined acceptance values
    ✓ should correctly set needsAny when both need reacceptance
    ✓ should correctly set needsAny when only terms needs reacceptance (1 ms)
    ✓ should correctly set needsAny when only privacy needs reacceptance
    ✓ should handle new user with no previous acceptances
  Version Update Scenarios
    ✓ should require reacceptance after terms version update
    ✓ should require reacceptance after privacy version update
    ✓ should require reacceptance after both versions update

PASS src/models/__tests__/User.test.js
  User Model
    create
      ✓ should create a new user with hashed password (82 ms)
      ✓ should create user with custom tier (66 ms)
      ✓ should default to free tier if not specified (59 ms)
      ✓ should throw error if database fails (64 ms)
      ✓ should hash password with bcrypt before storing (56 ms)
    findByEmail
      ✓ should find user by email
      ✓ should return null if user not found
      ✓ should include password_hash in result
    findById
      ✓ should find user by ID
      ✓ should return null if user not found
    findOrCreateByGithub
      ✓ should return existing user by GitHub ID (1 ms)
      ✓ should link GitHub account to existing email and mark as verified
      ✓ should create new user with verified email
      ✓ should restore account when GitHub user is scheduled for deletion
      ✓ should restore and link when email account is scheduled for deletion
    validatePassword
      ✓ should return true for correct password (110 ms)
      ✓ should return false for incorrect password (106 ms)
      ✓ should return false if hash is null
      ✓ should return false if hash is undefined
      ✓ should handle bcrypt comparison correctly (155 ms)
    updateTier
      ✓ should update user tier successfully
      ✓ should support all tier levels (1 ms)
    delete
      ✓ should delete user and return true
      ✓ should return false if user not found
      ✓ should handle database errors
    Security
      ✓ should hash passwords with bcrypt (52 ms)
      ✓ should generate different hashes for same password (201 ms)
      ✓ should use bcrypt with sufficient salt rounds (50 ms)
    Edge Cases
      ✓ should handle special characters in email (51 ms)
      ✓ should handle special characters in password (101 ms)
      ✓ should handle very long passwords (50 ms)
      ✓ should handle empty result sets gracefully
      ✓ should handle database connection errors
    Password Reset
      setResetToken
        ✓ should set password reset token (1 ms)
        ✓ should update reset_token_expires timestamp
      findByResetToken
        ✓ should find user by valid reset token
        ✓ should return null for expired token
        ✓ should return null for non-existent token
      updatePassword
        ✓ should update user password with hashed value (51 ms)
        ✓ should hash password before storing (50 ms)
        ✓ should handle database errors (51 ms)
      clearResetToken
        ✓ should clear reset token and expiration
        ✓ should handle non-existent user
        ✓ should handle database errors
      Password Reset Flow
        ✓ should support complete password reset flow (50 ms)
    Integration Scenarios
      ✓ should support full user lifecycle (151 ms)
      ✓ should handle OAuth user creation and linking
    Email Verification
      createVerificationToken
        ✓ should create a verification token with 24-hour expiry (1 ms)
        ✓ should update existing user with token
        ✓ should generate unique tokens for multiple calls
        ✓ should handle database errors gracefully
      findByVerificationToken
        ✓ should find user by valid, non-expired token
        ✓ should return null for non-existent token
        ✓ should return null for expired token
        ✓ should only select necessary user fields
        ✓ should handle database errors
      markEmailAsVerified
        ✓ should mark email as verified and clear token
        ✓ should return updated user object
        ✓ should use RETURNING clause to get updated user
        ✓ should handle non-existent user
        ✓ should handle database errors
      Email Verification Flow Integration
        ✓ should complete full verification flow
        ✓ should handle token expiry correctly
        ✓ should allow creating new token after expiry (1 ms)

PASS tests/integration/auth.test.js
  Auth Routes Integration Tests
    POST /api/auth/signup
      ✓ should register a new user successfully (1438 ms)
      ✓ should reject signup with existing email (2 ms)
      ✓ should reject signup with invalid email (2 ms)
      ✓ should reject signup with short password (1 ms)
      ✓ should reject signup with missing fields (2 ms)
      ✓ should handle database errors gracefully (1 ms)
    POST /api/auth/login
      ✓ should login user with valid credentials (24 ms)
      ✓ should reject login with wrong password (2 ms)
      ✓ should reject login with non-existent email (2 ms)
      ✓ should reject login with invalid email format (2 ms)
      ✓ should reject login with missing fields (1 ms)
    GET /api/auth/me
      ✓ should return user info with valid JWT token (26 ms)
      ✓ should reject request without token (2 ms)
      ✓ should reject request with invalid token (1 ms)
      ✓ should handle user not found (23 ms)
    POST /api/auth/logout
      ✓ should logout authenticated user (25 ms)
      ✓ should reject logout without authentication
    POST /api/auth/forgot-password
      ✓ should accept valid email (placeholder) (2 ms)
      ✓ should return same response for non-existent email (security) (1 ms)
      ✓ should reject invalid email format (1 ms)
    POST /api/auth/reset-password
      ✓ should validate token length
      ✓ should validate password requirements (1 ms)
    GET /api/auth/github
      ✓ should redirect to GitHub OAuth (if configured) (1 ms)
    JWT Token Validation
      ✓ should accept token with "Bearer " prefix (25 ms)
      ✓ should accept token without "Bearer " prefix (24 ms)
      ✓ should reject expired token (103 ms)
    Response Sanitization
      ✓ should never return password_hash in responses (49 ms)

FAIL src/routes/__tests__/webhooks.test.js


  ● Test suite failed to run

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      48 |     // Clean up
      49 |     await sql`DELETE FROM subscriptions WHERE user_id IN (SELECT id FROM users WHERE email LIKE 'test-webhook-%')`;
    > 50 |     await sql`DELETE FROM users WHERE email LIKE 'test-webhook-%'`;
         |     ^
      51 |   });
      52 |
      53 |   describe('POST /api/webhooks/stripe', () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/webhooks.test.js:50:5)

PASS src/models/__tests__/Subscription.test.js
  Subscription Model
    create
      ✓ should create a new subscription (1215 ms)
      ✓ should create subscription with trial dates (154 ms)
      ✓ should enforce unique stripe_subscription_id (183 ms)
      ✓ should validate tier values (143 ms)
    findByStripeId
      ✓ should find subscription by Stripe ID (170 ms)
      ✓ should return null if subscription not found (146 ms)
    getActiveSubscription
      ✓ should return active subscription for user (176 ms)
      ✓ should return trialing subscription as active (168 ms)
      ✓ should return null if no active subscription (147 ms)
      ✓ should return most recent active subscription (214 ms)
    update
      ✓ should update subscription status (255 ms)
      ✓ should update multiple fields (178 ms)
      ✓ should return null if subscription not found (145 ms)
    cancel
      ✓ should cancel subscription at period end (178 ms)
      ✓ should cancel subscription immediately (184 ms)
    getStats
      ✓ should return subscription statistics (197 ms)

FAIL src/routes/__tests__/payments.test.js (5.521 s)
  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should include name in Stripe customer when both first_name and last_name exist

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      320 |
      321 |         // Cleanup
    > 322 |         await sql`DELETE FROM users WHERE id = ${userWithName.id}`;
          |         ^
      323 |       });
      324 |
      325 |       it('should NOT include name when first_name is missing', async () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:322:9)

  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should NOT include name when first_name is missing

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      370 |
      371 |         // Cleanup
    > 372 |         await sql`DELETE FROM users WHERE id = ${userNoFirstName.id}`;
          |         ^
      373 |       });
      374 |
      375 |       it('should NOT include name when last_name is missing', async () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:372:9)

  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should NOT include name when last_name is missing

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      420 |
      421 |         // Cleanup
    > 422 |         await sql`DELETE FROM users WHERE id = ${userNoLastName.id}`;
          |         ^
      423 |       });
      424 |
      425 |       it('should handle multi-part surnames correctly', async () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:422:9)

  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should handle multi-part surnames correctly

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      471 |
      472 |         // Cleanup
    > 473 |         await sql`DELETE FROM users WHERE id = ${userMultiPart.id}`;
          |         ^
      474 |       });
      475 |
      476 |       it('should enforce 255 character limit for combined name', async () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:473:9)

  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should enforce 255 character limit for combined name

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      531 |
      532 |         // Cleanup
    > 533 |         await sql`DELETE FROM users WHERE id = ${userLongName.id}`;
          |         ^
      534 |       });
      535 |     });
      536 |   });

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:533:9)


  ● Test suite failed to run

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      68 |   afterAll(async () => {
      69 |     // Clean up test users
    > 70 |     await sql`DELETE FROM users WHERE email LIKE 'test-payment-%'`;
         |     ^
      71 |   });
      72 |
      73 |   describe('POST /api/payments/create-checkout-session', () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:70:5)

PASS src/services/__tests__/claudeClient.test.js (6.573 s)
  ClaudeClient
    Constructor
      ✓ should initialize with API key from environment (4 ms)
      ✓ should set correct model
      ✓ should set max retries to 3 (1 ms)
    generate()
      ✓ should generate documentation successfully (1 ms)
      ✓ should call API with correct parameters (9 ms)
      ✓ should retry on failure with exponential backoff (1 ms)
      ✓ should throw error after max retries (12 ms)
      ✓ should handle rate limit errors (2 ms)
      ✓ should handle empty response gracefully (1 ms)
    generateWithStreaming()
      ✓ should stream documentation progressively (1 ms)
      ✓ should call API with streaming enabled
      ✓ should filter out non-text delta events (1 ms)
      ✓ should handle streaming errors (1 ms)
      ✓ should return empty string for empty stream
      ✓ should accumulate all chunks correctly (1 ms)
    sleep()
      ✓ should delay for specified milliseconds (1 ms)
      ✓ should work with different durations (55 ms)
    Error Handling
      ✓ should handle malformed API response (6005 ms)
      ✓ should handle network errors (1 ms)
      ✓ should handle authentication errors (1 ms)
    Integration Scenarios
      ✓ should handle very long prompts (1 ms)
      ✓ should handle special characters in prompts
      ✓ should handle concurrent requests (1 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL src/routes/__tests__/webhooks.test.js


  ● Test suite failed to run

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      48 |     // Clean up
      49 |     await sql`DELETE FROM subscriptions WHERE user_id IN (SELECT id FROM users WHERE email LIKE 'test-webhook-%')`;
    > 50 |     await sql`DELETE FROM users WHERE email LIKE 'test-webhook-%'`;
         |     ^
      51 |   });
      52 |
      53 |   describe('POST /api/webhooks/stripe', () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/webhooks.test.js:50:5)

FAIL src/routes/__tests__/payments.test.js (5.521 s)
  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should include name in Stripe customer when both first_name and last_name exist

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      320 |
      321 |         // Cleanup
    > 322 |         await sql`DELETE FROM users WHERE id = ${userWithName.id}`;
          |         ^
      323 |       });
      324 |
      325 |       it('should NOT include name when first_name is missing', async () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:322:9)

  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should NOT include name when first_name is missing

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      370 |
      371 |         // Cleanup
    > 372 |         await sql`DELETE FROM users WHERE id = ${userNoFirstName.id}`;
          |         ^
      373 |       });
      374 |
      375 |       it('should NOT include name when last_name is missing', async () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:372:9)

  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should NOT include name when last_name is missing

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      420 |
      421 |         // Cleanup
    > 422 |         await sql`DELETE FROM users WHERE id = ${userNoLastName.id}`;
          |         ^
      423 |       });
      424 |
      425 |       it('should handle multi-part surnames correctly', async () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:422:9)

  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should handle multi-part surnames correctly

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      471 |
      472 |         // Cleanup
    > 473 |         await sql`DELETE FROM users WHERE id = ${userMultiPart.id}`;
          |         ^
      474 |       });
      475 |
      476 |       it('should enforce 255 character limit for combined name', async () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:473:9)

  ● Payment Routes › Name Field Sync (Migration 008) › App → Stripe: Send name when creating customer › should enforce 255 character limit for combined name

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      531 |
      532 |         // Cleanup
    > 533 |         await sql`DELETE FROM users WHERE id = ${userLongName.id}`;
          |         ^
      534 |       });
      535 |     });
      536 |   });

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:533:9)


  ● Test suite failed to run

    NeonDbError: update or delete on table "users" violates foreign key constraint "user_audit_log_user_id_fkey" on table "user_audit_log"

      68 |   afterAll(async () => {
      69 |     // Clean up test users
    > 70 |     await sql`DELETE FROM users WHERE email LIKE 'test-payment-%'`;
         |     ^
      71 |   });
      72 |
      73 |   describe('POST /api/payments/create-checkout-session', () => {

      at execute (node_modules/@neondatabase/serverless/index.js:1555:56)
      at Object.<anonymous> (src/routes/__tests__/payments.test.js:70:5)


Test Suites: 2 failed, 1 skipped, 29 passed, 31 of 32 total
Tests:       5 failed, 21 skipped, 871 passed, 897 total
Snapshots:   0 total
Time:        7.262 s
Ran all test suites.
